<!doctype html>
<html>
    <head>
        <title>TaskMan</title>
        <link rel="stylesheet" href="styles/clock.css"/>
    </head>
    <body>
        
        <div id="clock">
        
            <div id="timeLabel"></div>
            <div id="untilLabel">until</div>
            <div id="eventLabel"></div>
            
        </div>
        
        <script src="scripts/jquery.min.js"></script>
        <script>
            
            var triggered = false;
            var data = {
                
            }
            
                //var destTime = Date.parse(data.date);
                var interval = setInterval(function() {
                    if(!data.date) return;
                    
                    $("body").css("background-color", data.bgcolor).css("color", data.fgcolor);
                    
                    
                    $("#eventLabel").text(data.name);
                    
                    var now = new Date();

                    var diff = data.date - now;
                    if(triggered && diff > 0) {
                        triggered = false;
                    }
                    
                    if(diff < 0) {
                        if(!triggered) {
                            triggered = true;
                            $("#timeLabel").text("Now!");
                        }
                        //clearInterval(interval);
                        return;
                    }

                    var seconds = Math.floor(diff / 1000);
                    var minutes = Math.floor(seconds / 60);
                    var hours = Math.floor(minutes / 60);

                    if(!data.showSeconds && minutes > 30) {
                        seconds = 0;
                        minutes = minutes % 60;
                        var text = hours + ":" + (minutes < 10 ? "0" + minutes : minutes);
                    } else {
                        seconds = seconds % 60;
                        minutes = minutes % 60;
                        var text = hours + ":" + (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
                    }

                    

                    $("#timeLabel").text(text);
                }, 500);

            var refresh = null;
            
            var loaderFunc = function() {
                
                $.ajax({
                    url: "clock.json",
                    dataType: "json",
                    cache: false,
                    success: function(data2) {
                        data = data2;
                        data.date = Date.parse(data.date);
                        
                        if(refresh === null) {
                            refresh = data.refresh;
                        } else {
                            if(refresh !== data.refresh) {
                                window.location = window.location;
                            }
                        }
                    },
                    complete: function() {
                        setTimeout(loaderFunc, 10000);
                    }
                })
                
            };
            
            loaderFunc();
            
        </script>
    </body>
</html>